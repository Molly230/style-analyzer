"use client";

import { RefreshCw, Download, Share2, Palette, Scissors, Shirt, Sparkles } from 'lucide-react';
import { useState } from 'react';
import VirtualTryOn from './VirtualTryOn';
import ColorSelectionTest from './ColorSelectionTest';

interface StyleResultsProps {
  result: {
    faceShape: string;
    skinTone: string;
    skinUndertone: string;
    confidence?: number;
    originalImage?: string;
    croppedImage?: string;
    colorTestResult?: {
      season: string;
      confidence: number;
      bestColors: string[];
    };
    recommendations: {
      colors: string[];
      patterns: string[];
      necklines: string[];
      hairColors: string[];
      bangs: string[];
      accessories?: string[];
      makeupTips?: string[];
    };
  };
  onRestart: () => void;
}

const FACE_SHAPE_NAMES: Record<string, string> = {
  oval: 'æ¤­åœ†å½¢è„¸',
  round: 'åœ†å½¢è„¸',
  square: 'æ–¹å½¢è„¸',
  heart: 'å¿ƒå½¢è„¸',
  long: 'é•¿å½¢è„¸',
  diamond: 'é’»çŸ³å½¢è„¸',
  triangle: 'ä¸‰è§’å½¢è„¸',
  rectangle: 'é•¿æ–¹å½¢è„¸'
};

const SKIN_TONE_NAMES: Record<string, string> = {
  cool: 'å†·è‰²è°ƒ',
  warm: 'æš–è‰²è°ƒ',
  neutral: 'ä¸­æ€§è‰²è°ƒ'
};

const PATTERN_NAMES: Record<string, string> = {
  'solid': 'çº¯è‰²',
  'small florals': 'å°ç¢èŠ±',
  'subtle stripes': 'ç»†æ¡çº¹',
  'geometric': 'å‡ ä½•å›¾æ¡ˆ',
  'polka dots': 'æ³¢ç‚¹',
  'abstract': 'æŠ½è±¡å›¾æ¡ˆ'
};

const NECKLINE_NAMES: Record<string, string> = {
  'v-neck': 'Vé¢†',
  'scoop neck': 'åœ†é¢†',
  'boat neck': 'ä¸€å­—é¢†',
  'high neck': 'é«˜é¢†',
  'off-shoulder': 'ä¸€å­—è‚©',
  'square neck': 'æ–¹é¢†'
};

const BANG_NAMES: Record<string, string> = {
  'side-swept': 'ä¾§åˆ†åˆ˜æµ·',
  'curtain bangs': 'å…«å­—åˆ˜æµ·',
  'straight': 'é½åˆ˜æµ·',
  'wispy': 'ç©ºæ°”åˆ˜æµ·',
  'no bangs': 'æ— åˆ˜æµ·'
};

export default function StyleResults({ result, onRestart }: StyleResultsProps) {
  const [activeTab, setActiveTab] = useState<'colors' | 'style' | 'hair' | 'tryOn' | 'colorTest'>('colorTest');
  const [colorTestCompleted, setColorTestCompleted] = useState(false);
  const [personalColorResult, setPersonalColorResult] = useState<{
    season: string;
    confidence: number;
    bestColors: string[];
  } | null>(null);

  const generateReport = () => {
    const report = `
=== ç¾é¢œé£æ ¼åˆ†ææŠ¥å‘Š ===

ğŸ‘¤ é¢éƒ¨åˆ†æç»“æœ:
â€¢ è„¸å‹: ${FACE_SHAPE_NAMES[result.faceShape]}
â€¢ è‚¤è‰²: ${SKIN_TONE_NAMES[result.skinTone]}è‰²è°ƒ
â€¢ è‚¤è‰²åŸºè°ƒ: ${result.skinUndertone}è°ƒ

ğŸ¨ è‰²å½©æ¨è:
${result.recommendations.colors.map(color => `â€¢ ${color}`).join('\n')}

ğŸ‘— ç©¿æ­å»ºè®®:
â€¢ å›¾æ¡ˆ: ${result.recommendations.patterns.map(p => PATTERN_NAMES[p] || p).join('ã€')}
â€¢ é¢†å‹: ${result.recommendations.necklines.map(n => NECKLINE_NAMES[n] || n).join('ã€')}

ğŸ’‡â€â™€ï¸ å‘å‹å»ºè®®:
â€¢ å‘è‰²: ${result.recommendations.hairColors.join('ã€')}
â€¢ åˆ˜æµ·: ${result.recommendations.bangs.map(b => BANG_NAMES[b] || b).join('ã€')}

Generated by AI Style Analyzer
    `.trim();
    
    return report;
  };

  const shareResults = async () => {
    if (navigator.share) {
      try {
        await navigator.share({
          title: 'æˆ‘çš„é£æ ¼åˆ†æç»“æœ',
          text: generateReport(),
          url: window.location.href
        });
      } catch (error) {
        console.log('åˆ†äº«å–æ¶ˆæˆ–å¤±è´¥');
      }
    } else {
      navigator.clipboard.writeText(generateReport());
      alert('ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
    }
  };

  const downloadReport = () => {
    const report = generateReport();
    const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'é£æ ¼åˆ†ææŠ¥å‘Š.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  return (
    <div className="space-y-8">
      {/* ç»“æœæ ‡é¢˜ */}
      <div className="text-center">
        <h2 className="text-3xl font-bold text-gray-800 mb-2">
          âœ¨ ä½ çš„ä¸“å±é£æ ¼æŠ¥å‘Š
        </h2>
        <p className="text-gray-600">
          åŸºäºAIåˆ†æï¼Œä¸ºä½ é‡èº«å®šåˆ¶çš„ç¾å­¦å»ºè®®
        </p>
      </div>

      {/* åŸºç¡€åˆ†æç»“æœ */}
      <div className="grid md:grid-cols-3 gap-6 mb-8">
        <div className="bg-gradient-to-br from-pink-50 to-pink-100 rounded-xl p-6 text-center">
          <div className="text-2xl mb-2">ğŸ‘¤</div>
          <h3 className="font-semibold text-gray-800 mb-1">è„¸å‹åˆ†æ</h3>
          <p className="text-pink-600 font-medium">
            {FACE_SHAPE_NAMES[result.faceShape]}
          </p>
        </div>
        
        <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 text-center">
          <div className="text-2xl mb-2">ğŸ¨</div>
          <h3 className="font-semibold text-gray-800 mb-1">è‚¤è‰²è¯Šæ–­</h3>
          <p className="text-purple-600 font-medium">
            {SKIN_TONE_NAMES[result.skinTone]}
          </p>
        </div>
        
        <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 text-center">
          <div className="text-2xl mb-2">ğŸ’«</div>
          <h3 className="font-semibold text-gray-800 mb-1">è‚¤è‰²åŸºè°ƒ</h3>
          <p className="text-blue-600 font-medium">
            {result.skinUndertone}è°ƒ
          </p>
        </div>
      </div>

      {/* æ ‡ç­¾å¯¼èˆª */}
      <div className="flex justify-center mb-6 px-2">
        <div className="bg-gray-100 rounded-lg p-1 flex overflow-x-auto w-full max-w-2xl">
          {[
            ...(result.croppedImage && !colorTestCompleted ? [{ id: 'colorTest', label: 'è‰²å½©æµ‹è¯•', icon: Palette }] : []),
            { id: 'colors', label: 'è‰²å½©æ­é…', icon: Palette },
            { id: 'style', label: 'æœè£…é£æ ¼', icon: Shirt },
            { id: 'hair', label: 'å‘å‹å»ºè®®', icon: Scissors },
            ...(result.originalImage ? [{ id: 'tryOn', label: 'è™šæ‹Ÿè¯•å¦†', icon: Sparkles }] : [])
          ].map((tab) => {
            const Icon = tab.icon;
            return (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as 'colors' | 'style' | 'hair' | 'tryOn' | 'colorTest')}
                className={`
                  flex items-center gap-1 sm:gap-2 px-3 sm:px-6 py-2 sm:py-3 rounded-md font-medium transition-all whitespace-nowrap text-sm sm:text-base flex-shrink-0
                  ${activeTab === tab.id
                    ? 'bg-white text-pink-600 shadow-sm'
                    : 'text-gray-600 hover:text-gray-800'
                  }
                `}
              >
                <Icon size={16} className="sm:w-5 sm:h-5" />
                <span className="hidden sm:inline">{tab.label}</span>
                <span className="sm:hidden">{tab.label.split('')[0]}</span>
              </button>
            );
          })}
        </div>
      </div>

      {/* è¯¦ç»†æ¨èå†…å®¹ */}
      <div className="bg-white rounded-xl border border-gray-200 p-4 sm:p-8">
        {activeTab === 'colorTest' && result.croppedImage && (
          <ColorSelectionTest
            croppedImage={result.croppedImage}
            onComplete={(selectedColors, recommendation) => {
              setPersonalColorResult({ selectedColors, recommendation });
              setColorTestCompleted(true);
              setActiveTab('colors');
            }}
          />
        )}

        {activeTab === 'colors' && (
          <div>
            <h3 className="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
              <Palette className="text-pink-500" size={24} />
              ä¸“å±è‰²å½©æ­é…
            </h3>
            
            <div className="space-y-6">
              {/* æ˜¾ç¤ºä¸ªäººè‰²å½©æµ‹è¯•ç»“æœ */}
              {personalColorResult && (
                <div className="bg-gradient-to-r from-pink-50 to-purple-50 rounded-lg p-6 mb-6">
                  <h4 className="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    ğŸ¨ åŸºäºä½ çš„ä¸ªäººåå¥½åˆ†æ
                  </h4>
                  <div className="grid md:grid-cols-2 gap-6">
                    <div>
                      <p className="text-sm text-gray-600 mb-3">
                        è‰²è°ƒåå¥½åˆ†æï¼š
                      </p>
                      <div className="space-y-2">
                        <div className="flex items-center justify-between">
                          <span className="text-sm">æš–è‰²è°ƒ</span>
                          <div className="flex items-center gap-2">
                            <div className="w-24 bg-gray-200 rounded-full h-2">
                              <div 
                                className="bg-orange-400 h-2 rounded-full"
                                style={{ width: `${personalColorResult.recommendation.categoryPercentages.warm}%` }}
                              />
                            </div>
                            <span className="text-xs text-gray-600">
                              {personalColorResult.recommendation.categoryPercentages.warm}%
                            </span>
                          </div>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-sm">å†·è‰²è°ƒ</span>
                          <div className="flex items-center gap-2">
                            <div className="w-24 bg-gray-200 rounded-full h-2">
                              <div 
                                className="bg-blue-400 h-2 rounded-full"
                                style={{ width: `${personalColorResult.recommendation.categoryPercentages.cool}%` }}
                              />
                            </div>
                            <span className="text-xs text-gray-600">
                              {personalColorResult.recommendation.categoryPercentages.cool}%
                            </span>
                          </div>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-sm">ä¸­æ€§è‰²è°ƒ</span>
                          <div className="flex items-center gap-2">
                            <div className="w-24 bg-gray-200 rounded-full h-2">
                              <div 
                                className="bg-gray-400 h-2 rounded-full"
                                style={{ width: `${personalColorResult.recommendation.categoryPercentages.neutral}%` }}
                              />
                            </div>
                            <span className="text-xs text-gray-600">
                              {personalColorResult.recommendation.categoryPercentages.neutral}%
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div>
                      <p className="text-sm text-gray-600 mb-3">ä½ æœ€å–œæ¬¢çš„é¢œè‰²ï¼š</p>
                      <div className="flex flex-wrap gap-2">
                        {personalColorResult.selectedColors.slice(0, 6).map((color: { color: string; name: string; count: number }, index: number) => (
                          <div key={index} className="flex items-center gap-1">
                            <div 
                              className="w-6 h-6 rounded-full border border-gray-300"
                              style={{ backgroundColor: color.color }}
                            />
                            <span className="text-xs bg-pink-100 text-pink-700 px-2 py-1 rounded-full">
                              {color.count}
                            </span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              )}

              <div>
                <h4 className="font-medium text-gray-700 mb-4">
                  {personalColorResult ? 'æ ¹æ®ä½ çš„åå¥½æ¨è' : 'åŸºç¡€è‰²å½©æ¨è'}
                </h4>
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                  {(personalColorResult 
                    ? personalColorResult.recommendation.recommendedColors 
                    : result.recommendations.colors
                  ).map((color: string, index: number) => (
                    <div key={index} className="text-center">
                      <div
                        className="w-12 h-12 sm:w-16 sm:h-16 mx-auto rounded-lg shadow-md border border-gray-200 mb-2"
                        style={{ backgroundColor: typeof color === 'string' ? color : color.color }}
                      />
                      <p className="text-xs sm:text-sm text-gray-600">
                        {typeof color === 'string' ? color : color.name}
                      </p>
                    </div>
                  ))}
                </div>
              </div>
              
              <div>
                <h4 className="font-medium text-gray-700 mb-3">æ¨èå›¾æ¡ˆ</h4>
                <div className="flex flex-wrap gap-2">
                  {result.recommendations.patterns.map((pattern, index) => (
                    <span
                      key={index}
                      className="bg-pink-50 text-pink-700 px-4 py-2 rounded-full text-sm font-medium"
                    >
                      {PATTERN_NAMES[pattern] || pattern}
                    </span>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'style' && (
          <div>
            <h3 className="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
              <Shirt className="text-purple-500" size={24} />
              æœè£…é£æ ¼å»ºè®®
            </h3>
            
            <div className="space-y-6">
              <div>
                <h4 className="font-medium text-gray-700 mb-3">æœ€ä½³é¢†å‹é€‰æ‹©</h4>
                <div className="grid md:grid-cols-2 gap-4">
                  {result.recommendations.necklines.map((neckline, index) => (
                    <div key={index} className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                      <h5 className="font-medium text-purple-800 mb-1">
                        {NECKLINE_NAMES[neckline] || neckline}
                      </h5>
                      <p className="text-purple-600 text-sm">
                        é€‚åˆä½ çš„è„¸å‹ï¼Œèƒ½å¾ˆå¥½åœ°ä¿®é¥°é¢éƒ¨è½®å»“
                      </p>
                    </div>
                  ))}
                </div>
              </div>
              
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 className="font-medium text-blue-800 mb-2">ğŸ’¡ æ­é…å°è´´å£«</h4>
                <ul className="text-blue-700 text-sm space-y-1">
                  <li>â€¢ æ ¹æ®ä½ çš„{FACE_SHAPE_NAMES[result.faceShape]}ç‰¹å¾ï¼Œé¿å…è¿‡äºç´§è´´çš„é«˜é¢†è®¾è®¡</li>
                  <li>â€¢ {SKIN_TONE_NAMES[result.skinTone]}çš„è‚Œè‚¤é€‚åˆé€‰æ‹©ç›¸åº”è‰²æ¸©çš„é…é¥°</li>
                  <li>â€¢ å¯ä»¥å°è¯•å æ­æ¥ä¸°å¯Œæ•´ä½“é€ å‹çš„å±‚æ¬¡æ„Ÿ</li>
                </ul>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'hair' && (
          <div>
            <h3 className="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
              <Scissors className="text-green-500" size={24} />
              å‘å‹é€ å‹å»ºè®®
            </h3>
            
            <div className="space-y-6">
              <div>
                <h4 className="font-medium text-gray-700 mb-4">æ¨èå‘è‰²</h4>
                <div className="grid grid-cols-3 gap-4">
                  {result.recommendations.hairColors.map((color, index) => (
                    <div key={index} className="text-center">
                      <div
                        className="w-12 h-12 mx-auto rounded-full shadow-md border border-gray-200 mb-2"
                        style={{ backgroundColor: color }}
                      />
                      <p className="text-sm text-gray-600">{color}</p>
                    </div>
                  ))}
                </div>
              </div>
              
              <div>
                <h4 className="font-medium text-gray-700 mb-3">åˆ˜æµ·å»ºè®®</h4>
                <div className="space-y-3">
                  {result.recommendations.bangs.map((bang, index) => (
                    <div key={index} className="bg-green-50 border border-green-200 rounded-lg p-4">
                      <h5 className="font-medium text-green-800 mb-1">
                        {BANG_NAMES[bang] || bang}
                      </h5>
                      <p className="text-green-600 text-sm">
                        èƒ½å¤Ÿå¾ˆå¥½åœ°å¹³è¡¡ä½ çš„é¢éƒ¨æ¯”ä¾‹ï¼Œå‡¸æ˜¾ä¼˜åŠ¿
                      </p>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'tryOn' && result.originalImage && (
          <VirtualTryOn
            originalImage={result.originalImage}
            recommendations={{
              colors: result.recommendations.colors,
              hairColors: result.recommendations.hairColors,
              bangs: result.recommendations.bangs
            }}
          />
        )}
      </div>

      {/* æ“ä½œæŒ‰é’® */}
      <div className="flex flex-wrap justify-center gap-4">
        <button
          onClick={shareResults}
          className="bg-blue-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-600 transition-colors flex items-center gap-2"
        >
          <Share2 size={18} />
          åˆ†äº«ç»“æœ
        </button>
        
        <button
          onClick={downloadReport}
          className="bg-green-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-600 transition-colors flex items-center gap-2"
        >
          <Download size={18} />
          ä¸‹è½½æŠ¥å‘Š
        </button>
        
        <button
          onClick={onRestart}
          className="bg-gray-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-gray-600 transition-colors flex items-center gap-2"
        >
          <RefreshCw size={18} />
          é‡æ–°åˆ†æ
        </button>
      </div>

      {/* å…è´£å£°æ˜ */}
      <div className="text-center text-xs text-gray-500 border-t pt-4">
        * æœ¬åˆ†æç»“æœä»…ä¾›å‚è€ƒï¼Œä¸ªäººé£æ ¼å› äººè€Œå¼‚ï¼Œå»ºè®®ç»“åˆå®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´
      </div>
    </div>
  );
}